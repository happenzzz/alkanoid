<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>벽돌깨기 — 겨울안전 퀴즈</title>
<style>
  :root{
    --bg:#0a0e17;        /* 깊은 남색 배경 */
    --ink:#e6f0ff;       /* HUD 글자색 */
    --accent:#00ffd5;    /* 네온 포인트 */
    --accent2:#ff4d6d;
    --panel:#121826;     /* 패널 */
    --line:#1b2233;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 10%, #10182a 10%, var(--bg) 60%)}
  body{display:flex;flex-direction:column;align-items:center;gap:12px;font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;color:var(--ink)}
  header{width:min(100%,960px); display:flex;justify-content:space-between; align-items:center; padding:10px 14px; border:1px solid var(--line); background:linear-gradient(180deg, #121826, #0f1524); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); position:relative}
  header .hud{font-weight:900; letter-spacing:1px; text-shadow:0 0 6px rgba(0,255,213,.35)}
  #timer{position:absolute; left:50%; transform:translateX(-50%); font-weight:900; letter-spacing:1px; text-shadow:0 0 6px rgba(0,255,213,.35)}
  #wrap{position:relative; width:min(100%,960px); aspect-ratio:4/3; border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow: 0 20px 40px rgba(0,0,0,.45)}
  canvas{width:100%; height:100%; display:block; background: repeating-linear-gradient(180deg, #0b1120 0 2px, #0a1020 2px 4px)}

  /* CRT 스캔라인 + 글로우 */
  #wrap::after{
    content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen;
    background-image: linear-gradient(rgba(255,255,255,.04) 1px, transparent 3px);
    background-size:100% 4px; opacity:.35; filter:drop-shadow(0 0 10px rgba(0,255,213,.05));
  }

  /* 오버레이 */
  .overlay{position:absolute; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter: blur(2px);} 
  .overlay.show{display:flex}
  .panel{background:linear-gradient(180deg, #0d162a, #0b1222); border:1px solid var(--line); border-radius:16px; width:min(92%,720px); max-height:86%; overflow:auto; box-shadow:0 18px 50px rgba(0,0,0,.5)}
  .panel header{background:none; border:none; box-shadow:none; width:100%; border-bottom:1px solid var(--line); border-radius:16px 16px 0 0}
  .panel .content{padding:18px}
  .panel h2{margin:0 0 8px 0; font-size:20px; letter-spacing:1px}
  .panel .choices{display:grid; gap:10px; margin:12px 0}
  .panel .choices label{display:grid; grid-template-columns:18px 1fr; gap:8px; align-items:start; padding:8px 10px; border:1px solid #2b3856; border-radius:10px; background:rgba(255,255,255,0.02)}
  .panel .choices.revealed input{pointer-events:none}
  .panel .choices label.correct{border-color:#2dd4bf; background:rgba(45,212,191,.12); box-shadow:0 0 0 2px rgba(45,212,191,.25) inset}
  .panel .choices label.wrong{border-color:#ff6b6b; background:rgba(255,107,107,.12); box-shadow:0 0 0 2px rgba(255,107,107,.25) inset}
  .panel button{font-family:inherit; cursor:pointer; border:1px solid var(--accent); color:var(--ink); background:transparent; padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:1px}
  .panel button:hover{box-shadow:0 0 0 3px rgba(0,255,213,.12) inset}
  .pill{display:inline-block; padding:4px 10px; border:1px solid #26406a; border-radius:999px; font-weight:800; font-size:12px; color:#a9c0ff; letter-spacing:.5px}
  .status{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; text-align:center}
  .status .msg{font-size:28px; font-weight:900; letter-spacing:2px; color:var(--accent); text-shadow:0 0 12px rgba(0,255,213,.35)}
  .status .msg.red{color:#ff5b5b; text-shadow:0 0 12px rgba(255,80,80,.35)}

  input[type="text"]{outline:none}
  button[disabled]{opacity:.5; pointer-events:none}
</style>
</head>
<body>
  <header>
    <div class="hud" id="life">LIFE ♥♥♥♥</div>
    <div class="hud" id="timer">⏱ 05:00</div>
    <div class="hud" id="score">SCORE 0000</div>
  </header>

  <div id="wrap">
    <canvas id="game" width="960" height="720" aria-label="벽돌깨기 게임"></canvas>

    <!-- 상태 메시지 -->
    <div class="status" id="status">
      <div class="msg" id="statusMsg">PRESS ENTER</div>
    </div>

    <!-- 퀴즈 모달 -->
    <div class="overlay" id="quizOverlay" role="dialog" aria-modal="true">
      <div class="panel">
        <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px">
          <div class="pill" id="quizBadge">겨울안전 퀴즈</div>
          <div class="pill" id="quizBonus">BONUS +1000</div>
        </header>
        <div class="content">
          <h2 id="qText">Q. 추운 날…?</h2>
          <div class="choices" id="qChoices"></div>
          <div id="qExplain" style="display:none; margin:8px 0 2px 0; color:#a6e3ff"></div>
          <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap">
            <button id="submitAnswer" title="Enter">정답 제출(Enter)</button>
            <span class="pill">←/→/↑/↓ 또는 숫자키(1~4)로 선택 · 공개 후 Enter로 계속</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 종료 모달 -->
    <div class="overlay" id="endOverlay" role="dialog" aria-modal="true">
      <div class="panel">
        <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px">
          <div class="pill">결과</div>
          <div class="pill" id="endTime">⏱ 00:00</div>
        </header>
        <div class="content">
          <h2 id="endTitle">GAME OVER</h2>
          <p id="endDetail" style="opacity:.9">최종 점수: 0</p>

          <!-- 이름 입력란 (ALL CLEAR에서만 보임) -->
          <div id="nameWrap" style="display:none; margin:12px 0; gap:8px; align-items:center; justify-content:flex-start; flex-wrap:wrap;">
            <label for="playerName" class="pill" style="margin-right:8px">이름</label>
            <input id="playerName" type="text" placeholder="이름을 입력하세요" maxlength="12"
                   style="flex:1; min-width:220px; padding:10px 12px; border:1px solid #26406a; border-radius:10px; background:transparent; color:#e6f0ff; font-family:inherit; font-weight:800; letter-spacing:1px;">
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button id="btnRestart" title="Enter">타이틀로(Enter)</button>
            <button id="btnSavePng" title="PNG로 저장">PNG로 저장</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <footer style="opacity:.7; font-size:12px">
    타이틀: PRESS ENTER → 시작 / 게임 중: ←→ 이동, Space 일시정지 / 서브 준비: Enter·Space로 발사 / 퀴즈: 제출→공개→Enter로 계속
  </footer>

<script>
(function(){
  // ===== 유틸 =====
  const $ = sel => document.querySelector(sel);
  const timerEl = $('#timer');
  const scoreEl = $('#score');
  const lifeEl = $('#life');
  const statusEl = $('#status');
  const statusMsg = $('#statusMsg');

  // ===== 캔버스 세팅 =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // ===== 게임 상태 =====
  let running = false;
  let paused = false;
  let over = false;
  let score = 0;
  let remaining = 300; // 5분
  let lastTs = 0;
  let redUnlocked = false;
  let greensLeft = 5;
  let yellowsLeft = 3;
  let redsLeft = 2;
  let lives = 4;
  let awaitServe = false; // 새 서브 대기 상태 (공이 패들에 붙어있음)

  // ===== 패들 & 볼 =====
  const paddle = { w:120, h:18, x:W/2-60, y:H-40, speed:580 };
  const ball = { r:9, x:W/2, y:H-60, dx:0, dy:0, speedUp:1.02, max:720 };
  const INITIAL_SPEED = 320; // 서브 시 초기 속도 크기

  // ===== 벽돌 맵 =====
  const COLS = 12, ROWS = 6, GAP=4;
  const bw = Math.floor((W - (COLS+1)*GAP)/COLS);
  const bh = 28;
  const offsetTop = 80; const offsetLeft = Math.floor((W - (bw*COLS + GAP*(COLS+1)))/2);

  const TYPE = { BASIC:'basic', GREEN:'green', YELLOW:'yellow', RED:'red' };

  const greenPos = [ [2,1],[9,1],[3,2],[8,2],[5,3] ];       // 5개
  const yellowPos = [ [4,0],[7,0],[6,3] ];                  // 3개
  const redPos = [ [5,0],[6,0] ];                           // 2개(가운데 상단)

  let bricks = [];
  function makeBricks(){
    bricks = [];
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const x = offsetLeft + GAP + c*(bw+GAP);
        const y = offsetTop + GAP + r*(bh+GAP);
        let type = TYPE.BASIC, hp=1, locked=false;
        if (hasCoord(greenPos,c,r)) { type=TYPE.GREEN; hp=1; }
        else if (hasCoord(yellowPos,c,r)) { type=TYPE.YELLOW; hp=2; }
        else if (hasCoord(redPos,c,r)) { type=TYPE.RED; hp=1; locked=true; }
        bricks.push({x,y,w:bw,h:bh,type,hp,alive:true,locked});
      }
    }
  }

  function hasCoord(arr,c,r){return arr.some(p=>p[0]===c && p[1]===r)}

  // ===== 입력 =====
  const keys = {};
  window.addEventListener('keydown', e=>{ 
    keys[e.code]=true; 
    if(e.code==='Space'){
      e.preventDefault();
      if(running && !over){
        if(awaitServe){ launchBall(); }
        else { togglePause(); }
      }
    }
    if(e.code==='Enter'){
      if($('#endOverlay').classList.contains('show') && !isTyping()){
        resetToTitle();
      } else if(!running && !$('#quizOverlay').classList.contains('show')){
        startGame(); // 타이틀에서 게임 시작(서브 대기)
      } else if(running && awaitServe){
        launchBall();
      }
    }
  });
  window.addEventListener('keyup', e=>{ keys[e.code]=false });
  document.addEventListener('mousemove', e=>{
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (W/rect.width);
    paddle.x = Math.max(0, Math.min(W - paddle.w, mx - paddle.w/2));
  });

  function isTyping(){
    const el = document.activeElement; return el && (el.tagName==='INPUT' || el.tagName==='TEXTAREA');
  }

  function togglePause(){ if(!running||over||awaitServe) return; paused = !paused; statusMsg.textContent = paused? 'PAUSED' : ''; statusEl.style.display = paused? 'flex':'none'; }

  // ===== 타이틀로 복귀 =====
  function resetToTitle(){
    running=false; paused=false; over=false; if(timerI) clearInterval(timerI);
    score=0; remaining=300; lives=4; redUnlocked=false; greensLeft=5; yellowsLeft=3; redsLeft=2; awaitServe=false;
    statusMsg.innerHTML='PRESS ENTER'; statusEl.style.display='flex';
    $('#endOverlay').classList.remove('show');
    $('#quizOverlay').classList.remove('show');
    scoreEl.textContent = fmtScore(score);
    updateLifeHUD(); updateTimerText();
    nameWrap.style.display='none';
    btnSavePng.disabled=false; btnSavePng.title='PNG로 저장';
    if(playerName){ playerName.value=''; playerName.onkeydown=null; }
    // 화면을 깔끔하게: 패들 중앙, 공도 패들 위로 정렬(표시만)
    paddle.x = W/2 - paddle.w/2; paddle.y = H - 40;
    attachBallToPaddle();
    draw();
  }

  // ===== 타이머 =====
  let timerI = null;
  function startTimer(){
    remaining = 300; updateTimerText();
    if(timerI) clearInterval(timerI);
    timerI = setInterval(()=>{
      if(!running||paused) return;
      remaining = Math.max(0, remaining - 1);
      updateTimerText();
      if(remaining<=0){ gameOver(false); }
    },1000);
  }
  function updateTimerText(){
    const m = String(Math.floor(remaining/60)).padStart(2,'0');
    const s = String(remaining%60).padStart(2,'0');
    timerEl.textContent = `⏱ ${m}:${s}`;
  }

  function updateLifeHUD(){ lifeEl.textContent = 'LIFE ' + '♥'.repeat(lives); }

  // ===== 서브/공 붙이기 =====
  function attachBallToPaddle(){
    awaitServe = true;
    ball.dx = 0; ball.dy = 0;
    ball.x = paddle.x + paddle.w/2;
    ball.y = paddle.y - ball.r - 1;
    statusMsg.textContent = 'LAUNCH: ENTER / SPACE';
    statusEl.style.display = 'flex';
  }
  function launchBall(){
    const angle = (Math.random()*0.6 - 0.3); // -0.3~0.3 rad 약 ±17도
    const speed = INITIAL_SPEED;
    ball.dx = speed * Math.sin(angle) * (Math.random()<.5? -1:1);
    ball.dy = -Math.abs(speed * Math.cos(angle));
    awaitServe = false;
    statusEl.style.display='none';
  }

  // ===== 메인 루프 =====
  function startGame(){
    running = true; paused=false; over=false; lastTs=0;
    makeBricks();
    // 시작은 서브 대기(공은 패들 위)
    paddle.x = W/2 - paddle.w/2; paddle.y = H - 40;
    attachBallToPaddle();

    scoreEl.textContent = fmtScore(score);
    updateLifeHUD();
    startTimer();

    requestAnimationFrame(loop);
  }

  function loop(ts){
    if(!running) return;
    const dt = lastTs? (ts - lastTs)/1000 : 0; lastTs = ts;
    if(!paused && !over){ update(dt); draw(); }
    requestAnimationFrame(loop);
  }

  function update(dt){
    if(keys['ArrowLeft']) paddle.x -= paddle.speed*dt;
    if(keys['ArrowRight']) paddle.x += paddle.speed*dt;
    paddle.x = Math.max(0, Math.min(W-paddle.w, paddle.x));

    if(awaitServe){
      // 공을 패들에 붙여서 이동만 추적
      ball.x = paddle.x + paddle.w/2; ball.y = paddle.y - ball.r - 1;
      return; // 충돌/이동 계산 생략
    }

    ball.x += ball.dx*dt; ball.y += ball.dy*dt;

    if(ball.x < ball.r){ ball.x = ball.r; ball.dx *= -1; }
    if(ball.x > W - ball.r){ ball.x = W - ball.r; ball.dx *= -1; }
    if(ball.y < ball.r){ ball.y = ball.r; ball.dy *= -1; }

    if(ball.y > H - ball.r){ loseLife(); return; }

    if(rectCircleCollide(paddle, ball)){
      const hit = (ball.x - (paddle.x + paddle.w/2)) / (paddle.w/2);
      const speed = Math.min(Math.hypot(ball.dx, ball.dy)*ball.speedUp, ball.max);
      const angle = hit * Math.PI/3;
      ball.dx = speed * Math.sin(angle);
      ball.dy = -Math.abs(speed * Math.cos(angle));
      ball.y = paddle.y - ball.r - 1;
    }

    for(const b of bricks){
      if(!b.alive) continue;
      if(circleRectCollide(ball, b)){
        if(b.type===TYPE.RED && (!redUnlocked || b.locked)){
          flashStatus('RED LOCKED — 먼저 초록/노랑을 모두 깨야 해!', true); reflectBall(ball, b); continue;
        }
        b.hp -= 1; reflectBall(ball, b);
        if(b.hp<=0){
          b.alive = false;
          if(b.type===TYPE.BASIC){ score += 100; scoreEl.textContent = fmtScore(score); }

          if(b.type===TYPE.GREEN){ greensLeft = Math.max(0, greensLeft-1); openQuiz({bonus:1000, pool:GREEN_QUIZ}); }
          if(b.type===TYPE.YELLOW){ yellowsLeft = Math.max(0, yellowsLeft-1); openQuiz({bonus:2000, pool:YELLOW_QUIZ}); }
          if(b.type===TYPE.RED){
            redsLeft = Math.max(0, redsLeft-1);
            const isFinal = (redsLeft===0);
            openQuiz({bonus:isFinal?10000:5000, pool:isFinal?FINAL_QUIZ:RED_QUIZ, final:isFinal});
          }

          if(!redUnlocked && greensLeft===0 && yellowsLeft===0){
            redUnlocked = true; bricks.filter(x=>x.type===TYPE.RED).forEach(x=>x.locked=false);
            flashStatus('RED UNLOCKED! 빨강벽돌 격파 가능', false);
          }
        }
        break;
      }
    }

    if(bricks.every(b=>!b.alive)) gameOver(true);
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    ctx.globalAlpha = .06; ctx.fillStyle = '#9adfff';
    for(let i=0;i<60;i++){ ctx.fillRect((i*73)%W, (i*41)%H, 2, 2); }
    ctx.globalAlpha = 1;

    for(const b of bricks){ if(!b.alive) continue; drawBrick(b); }

    ctx.fillStyle = '#c7e3ff';
    roundRect(ctx, paddle.x, paddle.y, paddle.w, paddle.h, 6, true);

    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    const grd = ctx.createRadialGradient(ball.x-2, ball.y-2, 1, ball.x, ball.y, ball.r);
    grd.addColorStop(0, '#fff'); grd.addColorStop(1, '#7cd7ff');
    ctx.fillStyle = grd; ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,.35)'; ctx.stroke();

    ctx.globalAlpha=.15; ctx.strokeStyle='#00ffd5'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(20,60); ctx.lineTo(W-20,60); ctx.stroke(); ctx.globalAlpha=1;

    ctx.globalAlpha=.15; ctx.fillStyle = redUnlocked? '#00ffd5' : '#ff6b6b';
    ctx.font='700 14px ui-monospace, monospace';
    ctx.fillText(redUnlocked? '🔓 RED UNLOCKED' : '🔒 RED LOCKED', 20, 50);
    ctx.globalAlpha=1;
  }

  function drawBrick(b){
    ctx.save();
    ctx.translate(b.x, b.y);
    const grad = ctx.createLinearGradient(0,0, b.w, b.h);
    if(b.type==='green'){ grad.addColorStop(0,'#1e8e5a'); grad.addColorStop(1,'#35d07f'); }
    else if(b.type==='yellow'){ grad.addColorStop(0,'#c7a700'); grad.addColorStop(1,'#f8d34b'); }
    else if(b.type==='red'){ grad.addColorStop(0,'#b6172f'); grad.addColorStop(1,'#ff5b5b'); }
    else { grad.addColorStop(0,'#5562d6'); grad.addColorStop(1,'#9aa7ff'); }
    ctx.fillStyle = grad; roundRect(ctx, 0,0,b.w,b.h, 6, true);
    ctx.strokeStyle = 'rgba(255,255,255,.15)'; ctx.strokeRect(0.5,0.5,b.w-1,b.h-1);
    ctx.font='800 12px ui-monospace, monospace'; ctx.textAlign='center'; ctx.textBaseline='middle';
    if(b.type==='green'){ ctx.fillStyle='#d9ffe6'; ctx.fillText('G', b.w/2, b.h/2); }
    if(b.type==='yellow'){ ctx.fillStyle='#fff4c7'; ctx.fillText(b.hp===2?'Y(2)':'Y(1)', b.w/2, b.h/2); }
    if(b.type==='red'){ ctx.fillStyle='#ffd6da'; ctx.fillText(redUnlocked?'R':'R🔒', b.w/2, b.h/2); }
    ctx.restore();
  }

  function roundRect(ctx,x,y,w,h,r,fill){
    ctx.beginPath();
    ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
    if(fill) ctx.fill(); else ctx.stroke();
  }

  function rectCircleCollide(rect, c){
    const cx = Math.max(rect.x, Math.min(c.x, rect.x+rect.w));
    const cy = Math.max(rect.y, Math.min(c.y, rect.y+rect.h));
    const dx = c.x - cx, dy = c.y - cy; return (dx*dx + dy*dy) <= (c.r*c.r);
  }
  function circleRectCollide(c, rect){ return rectCircleCollide(rect,c); }
  function reflectBall(ball, rect){
    const prevX = ball.x - Math.sign(ball.dx);
    const prevY = ball.y - Math.sign(ball.dy);
    const fromLeft = prevX < rect.x;
    const fromRight = prevX > rect.x + rect.w;
    const fromTop = prevY < rect.y;
    const fromBottom = prevY > rect.y + rect.h;
    if(fromLeft || fromRight){ ball.dx *= -1; }
    if(fromTop || fromBottom){ ball.dy *= -1; }
  }

  function fmtScore(s){ return 'SCORE ' + String(s).padStart(4,'0'); }

  function flashStatus(text, danger){
    statusMsg.textContent = text; statusMsg.classList.toggle('red', !!danger); statusEl.style.display='flex';
    clearTimeout(flashStatus._t);
    flashStatus._t = setTimeout(()=>{ statusEl.style.display='none'; statusMsg.classList.remove('red'); }, 1200);
  }

  function loseLife(){
    if(over) return;
    lives--; updateLifeHUD();
    flashStatus('LIFE -1', true);
    if(lives<=0){ gameOver(false); return; }
    // 다음 서브 준비
    attachBallToPaddle();
  }

  // ===== 퀴즈 (색깔별 풀 분리) =====
  const quizOverlay = document.getElementById('quizOverlay');
  const qText = document.getElementById('qText');
  const qChoices = document.getElementById('qChoices');
  const qExplain = document.getElementById('qExplain');
  const quizBadge = document.getElementById('quizBadge');
  const quizBonus = document.getElementById('quizBonus');
  const btnSubmit = document.getElementById('submitAnswer');

  const GREEN_QUIZ = [
    {q:'난방기(보일러·가스난로 등) 사용 시 기본 안전수칙은?', c:['창문을 꼭 닫아둔다','정기적으로 환기한다','불꽃을 최대한 키운다','빨래를 바로 위에 말린다'], a:1, e:'일산화탄소 중독 예방을 위해 주기적 환기가 필수입니다.'},
    {q:'빙판길 보행 시 가장 안전한 방법은?', c:['보폭을 크게 한다','손을 주머니에 넣는다','보폭을 작게, 무게중심 낮게','휴대폰을 보며 걷는다'], a:2, e:'보폭을 줄이고 무게중심을 낮추면 미끄러짐을 줄일 수 있습니다.'},
    {q:'전기장판을 안전하게 사용하는 방법은?', c:['접어서 사용','항상 최고온도','두꺼운 이불 여러 겹','펴서 사용, 장시간 고온 피함'], a:3, e:'접거나 장시간 고온은 화재 위험. 펴서 사용하고 고온 유지 금지.'},
    {q:'스키장/눈썰매장에서 기본 수칙은?', c:['정지 연습은 필요 없음','헬멧·보호장구 착용','사람 많은 곳에서 속도 내기','코스 역주행'], a:1, e:'헬멧 등 보호장구를 착용하고 규칙을 지켜야 합니다.'}
  ];

  const YELLOW_QUIZ = [
    {q:'동상 의심 시 올바른 응급처치는?', c:['눈으로 세게 문지른다','50℃ 뜨거운 물에 빠르게 데운다','37~39℃ 미지근한 물에 서서히 데운다','바람 쐬며 자연회복'], a:2, e:'문지르면 손상, 너무 뜨거운 물도 금물. 미지근한 물에 서서히.'},
    {q:'블랙아이스가 특히 잘 생기는 곳은?', c:['햇볕 잘 드는 도로','터널·교량·그늘진 구간','도심 한복판','횡단보도만'], a:1, e:'그늘·교량·터널 출입구 등 노면온도가 낮은 구간.'},
    {q:'폭설 후 자동차 시동 전 반드시 확인할 것은?', c:['엔진오일 색','배기구(머플러) 막힘','와이퍼 고무 색','타이어 휠 디자인'], a:1, e:'배기구가 막히면 CO가 실내로 유입되어 매우 위험합니다.'},
    {q:'제설 작업 시 주의할 점은?', c:['짧은 시간 전력질주','허리 굽혀 빠르게 퍼내기','중간중간 쉬며 몸 풀기','사다리로 속도 높이기'], a:2, e:'무리하면 심혈관 부담 큼. 스트레칭·휴식이 중요.'}
  ];

  const RED_QUIZ = [
    {q:'혹한 속 저체온증 의심 시 대처는?', c:['뜨거운 욕조에 바로 넣기','찬물 샤워','따뜻한 장소로 이동해 보온·수분 보충','두꺼운 옷 벗어 식히기'], a:2, e:'따뜻한 장소로 이동, 젖은 옷 교체, 보온·수분 보충.'},
    {q:'가정용 CO(일산화탄소) 경보기 설치 위치는?', c:['천장 중앙 아무 곳','바닥 바로 위','보일러·가스기기 주변 벽면 높이(지침 준수)','현관문 바깥'], a:2, e:'제조사 지침 높이, 기기 근처에 설치.'},
    {q:'빙판에서 넘어질 때 비교적 안전한 자세는?', c:['손바닥 펴서 짚기','머리부터 앞으로 숙이기','몸을 웅크리고 옆으로 넘어가기','무릎을 쭉 편 채 미끄러지기'], a:2, e:'몸을 웅크려 충격 분산, 옆으로 넘어지듯.'},
    {q:'겨울철 호흡기 질환 기본 예방법은?', c:['손 씻기와 기침 예절 준수','마스크 절대 금지','따뜻한 음료만 마시기','하루 종일 난방 끄기'], a:0, e:'손 씻기·기침 예절·적절한 환기와 보온이 기본.'}
  ];

  const FINAL_QUIZ = [
    {q:'최후의 문제! 한파 대비 가정 안전 체크로 옳지 않은 것은?', c:['비상 물·손전등·건전지 준비','난방기 점검과 환기 병행','일산화탄소 경보기를 꺼 둔다','미끄럼 방지 신발 준비'], a:2, e:'경보기는 항상 켠 상태로 유지해야 합니다.'},
    {q:'최후의 문제! 혹한 속 저체온증 응급 대처는?', c:['뜨거운 욕조에 바로 넣는다','젖은 옷을 갈아입히고 담요로 보온','알코올을 마시게 한다','바람 쐬며 단련'], a:1, e:'젖은 옷 교체·보온, 의료기관으로 이동.'}
  ];

  function getRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  let quizKeyHandler = null;
  let currentBonus = 0;

  function openQuiz({bonus=1000, pool=GREEN_QUIZ, final=false}={}){
    if(over) return;
    paused = true; quizOverlay.classList.add('show');
    currentBonus = bonus;
    quizBadge.textContent = final? '최후의 문제' : '겨울안전 퀴즈';
    quizBonus.textContent = (final? 'FINAL +' : 'BONUS +') + bonus;

    const q = getRandom(pool);

    qText.textContent = 'Q. ' + q.q; qExplain.style.display='none'; qExplain.textContent='';
    qChoices.innerHTML = ''; qChoices.classList.remove('revealed');

    q.c.forEach((text, i)=>{
      const id = 'c_'+Date.now()+'_'+i;
      const label = document.createElement('label'); label.className='choice';
      const radio = document.createElement('input'); radio.type='radio'; radio.name='quizChoice'; radio.value=i; radio.id=id; radio.style.marginTop='2px';
      const span = document.createElement('span'); span.textContent = text;
      label.appendChild(radio); label.appendChild(span); qChoices.appendChild(label);
    });
    let idx = 0; const radios = [...qChoices.querySelectorAll('input[name="quizChoice"]')]; if(radios[0]) radios[0].checked = true;

    let revealed = false; // 정답 공개 여부
    let handled = false;  // 점수/라이프 처리 1회만

    const continuePlay = ()=>{
      quizOverlay.classList.remove('show');
      paused=false;
      if(quizKeyHandler){ window.removeEventListener('keydown', quizKeyHandler); quizKeyHandler=null; }
      if(lives<=0){ gameOver(false); }
    };

    const reveal = (isCorrect)=>{
      if(revealed) return; revealed = true; qChoices.classList.add('revealed');
      const choiceLabels = [...qChoices.querySelectorAll('label.choice')];
      const selIndex = radios.findIndex(r=>r.checked);
      choiceLabels.forEach((lab,i)=>{
        if(i===q.a) lab.classList.add('correct');
        if(i===selIndex && !isCorrect) lab.classList.add('wrong');
      });
      qExplain.style.display='block';
      if(!handled){
        handled = true;
        if(isCorrect){ score += currentBonus; scoreEl.textContent = fmtScore(score); qExplain.textContent = `정답! +${currentBonus}점 보너스. ` + q.e; }
        else { lives--; updateLifeHUD(); qExplain.textContent = '오답! 목숨 -1. ' + q.e; }
      }
      btnSubmit.textContent = '계속(Enter)';
    };

    btnSubmit.onclick = ()=>{
      if(!revealed){
        const sel = qChoices.querySelector('input[name="quizChoice"]:checked');
        if(!sel){ qExplain.style.display='block'; qExplain.textContent='정답을 선택해 주세요.'; return; }
        const isCorrect = Number(sel.value) === q.a;
        reveal(isCorrect);
      } else {
        continuePlay();
      }
    };

    if(quizKeyHandler){ window.removeEventListener('keydown', quizKeyHandler); }
    quizKeyHandler = (e)=>{
      const radios = [...qChoices.querySelectorAll('input[name="quizChoice"]')];
      if(!quizOverlay.classList.contains('show')) return;
      if(!revealed){
        if(['ArrowDown','ArrowRight','KeyS','KeyD'].includes(e.code)){
          idx = (idx+1) % radios.length; radios.forEach((r,i)=>r.checked = (i===idx)); e.preventDefault();
        } else if(['ArrowUp','ArrowLeft','KeyW','KeyA'].includes(e.code)){
          idx = (idx-1+radios.length) % radios.length; radios.forEach((r,i)=>r.checked = (i===idx)); e.preventDefault();
        } else if(/^Digit[1-9]$/.test(e.code)){
          const n = Math.min(9, Math.max(1, Number(e.code.replace('Digit','')))) - 1; if(radios[n]){ idx=n; radios.forEach((r,i)=>r.checked = (i===idx)); }
        } else if(e.code==='Enter'){ btnSubmit.click(); e.preventDefault(); }
      } else {
        if(e.code==='Enter'){ continuePlay(); e.preventDefault(); }
      }
    };
    window.addEventListener('keydown', quizKeyHandler);
  }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j]]; } return arr; }

  // ===== 엔딩 / 저장 =====
  const endOverlay = document.getElementById('endOverlay');
  const endTitle = document.getElementById('endTitle');
  const endDetail = document.getElementById('endDetail');
  const endTime = document.getElementById('endTime');
  const btnRestart = document.getElementById('btnRestart');
  const btnSavePng = document.getElementById('btnSavePng');
  const nameWrap = document.getElementById('nameWrap');
  const playerName = document.getElementById('playerName');

  btnRestart.onclick = ()=>{ resetToTitle(); };
  btnSavePng.onclick = ()=>{ if(!btnSavePng.disabled) savePNG(endTitle.textContent); };

  function savePNG(finalText){
    const off = document.createElement('canvas'); off.width = W; off.height = H; const g = off.getContext('2d');
    g.fillStyle = '#0a0e17'; g.fillRect(0,0,W,H);
    g.drawImage(canvas,0,0);
    g.fillStyle = 'rgba(0,0,0,0.65)'; g.fillRect(0, H-160, W, 160);
    g.fillStyle = '#ffffff';
    g.font = '700 34px ui-monospace, monospace'; g.fillText(finalText, 24, H-112);
    g.font = '700 24px ui-monospace, monospace'; g.fillText('SCORE: '+score, 24, H-80);
    const now = new Date();
    const stamp = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
    const pname = (playerName && playerName.value.trim()) || '';
    const footer = (pname? ('NAME: '+pname+'   •   ') : '') + 'TIME LEFT: ' + timerEl.textContent.replace('⏱ ','') + '   •   SAVED: ' + stamp;
    g.font = '600 16px ui-monospace, monospace'; g.fillText(footer, 24, H-48);

    const url = off.toDataURL('image/png');
    const a = document.createElement('a');
    const safe = finalText.split(' ').join('_').toLowerCase();
    a.href=url; a.download = `winter-breakout-${safe}-${Date.now()}.png`; a.click();
  }

  function gameOver(win){
    over = true; running=false; if(timerI) clearInterval(timerI);
    statusEl.style.display='flex';
    const title = win ? 'ALL CLEAR' : 'GAME OVER';
    statusMsg.innerHTML = win ? `🎉 ALL CLEAR!<br>최종 점수: ${score}` : `⏰ GAME OVER!<br>최종 점수: ${score}`;

    endTitle.textContent = title;
    endDetail.textContent = `최종 점수: ${score}`;
    endTime.textContent = timerEl.textContent;

    if(win){
      nameWrap.style.display='flex';
      if(playerName){
        playerName.value='';
        setTimeout(()=>playerName.focus(), 50);
        btnSavePng.disabled = true; btnSavePng.title='이름 입력 후 Enter로 저장';
        playerName.onkeydown = (e)=>{
          if(e.key==='Enter'){
            e.preventDefault();
            const v = playerName.value.trim();
            if(!v) return; // 빈 이름은 무시
            btnSavePng.disabled = false; btnSavePng.title='PNG로 저장';
            savePNG(endTitle.textContent); // Enter로 즉시 저장
          }
        };
      }
    } else {
      nameWrap.style.display='none';
      btnSavePng.disabled = false; btnSavePng.title='PNG로 저장';
      if(playerName) playerName.onkeydown = null;
    }

    endOverlay.classList.add('show');
  }

  // 초기: 타이틀 화면
  statusEl.style.display='flex';
  statusMsg.innerHTML = 'PRESS ENTER';
  // 캔버스 초기 표시는 패들+공을 하단에 그려 놓기
  attachBallToPaddle();
  draw();

})();
</script>
</body>
</html>
