<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë²½ëŒê¹¨ê¸° â€” ê²¨ìš¸ì•ˆì „ í€´ì¦ˆ</title>
<style>
  :root{
    --bg:#0a0e17;        /* ê¹Šì€ ë‚¨ìƒ‰ ë°°ê²½ */
    --ink:#e6f0ff;       /* HUD ê¸€ììƒ‰ */
    --accent:#00ffd5;    /* ë„¤ì˜¨ í¬ì¸íŠ¸ */
    --accent2:#ff4d6d;
    --panel:#121826;     /* íŒ¨ë„ */
    --line:#1b2233;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 10%, #10182a 10%, var(--bg) 60%)}
  body{display:flex;flex-direction:column;align-items:center;gap:12px;font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;color:var(--ink)}
  header{width:min(100%,960px); display:flex;justify-content:space-between; align-items:center; padding:10px 14px; border:1px solid var(--line); background:linear-gradient(180deg, #121826, #0f1524); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); position:relative}
  header .hud{font-weight:900; letter-spacing:1px; text-shadow:0 0 6px rgba(0,255,213,.35)}
  #timer{position:absolute; left:50%; transform:translateX(-50%); font-weight:900; letter-spacing:1px; text-shadow:0 0 6px rgba(0,255,213,.35)}
  #wrap{position:relative; width:min(100%,960px); aspect-ratio:4/3; border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow: 0 20px 40px rgba(0,0,0,.45)}
  canvas{width:100%; height:100%; display:block; background: repeating-linear-gradient(180deg, #0b1120 0 2px, #0a1020 2px 4px)}

  /* CRT ìŠ¤ìº”ë¼ì¸ + ê¸€ë¡œìš° */
  #wrap::after{
    content:""; position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen;
    background-image: linear-gradient(rgba(255,255,255,.04) 1px, transparent 3px);
    background-size:100% 4px; opacity:.35; filter:drop-shadow(0 0 10px rgba(0,255,213,.05));
  }

  /* ì˜¤ë²„ë ˆì´ */
  .overlay{position:absolute; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter: blur(2px);} 
  .overlay.show{display:flex}
  .panel{background:linear-gradient(180deg, #0d162a, #0b1222); border:1px solid var(--line); border-radius:16px; width:min(92%,720px); max-height:86%; overflow:auto; box-shadow:0 18px 50px rgba(0,0,0,.5)}
  .panel header{background:none; border:none; box-shadow:none; width:100%; border-bottom:1px solid var(--line); border-radius:16px 16px 0 0}
  .panel .content{padding:18px}
  .panel h2{margin:0 0 8px 0; font-size:20px; letter-spacing:1px}
  .panel .choices{display:grid; gap:10px; margin:12px 0}
  .panel .choices label{display:grid; grid-template-columns:18px 1fr; gap:8px; align-items:start; padding:8px 10px; border:1px solid #2b3856; border-radius:10px; background:rgba(255,255,255,0.02)}
  .panel .choices.revealed input{pointer-events:none}
  .panel .choices label.correct{border-color:#2dd4bf; background:rgba(45,212,191,.12); box-shadow:0 0 0 2px rgba(45,212,191,.25) inset}
  .panel .choices label.wrong{border-color:#ff6b6b; background:rgba(255,107,107,.12); box-shadow:0 0 0 2px rgba(255,107,107,.25) inset}
  .panel button{font-family:inherit; cursor:pointer; border:1px solid var(--accent); color:var(--ink); background:transparent; padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:1px}
  .panel button:hover{box-shadow:0 0 0 3px rgba(0,255,213,.12) inset}
  .pill{display:inline-block; padding:4px 10px; border:1px solid #26406a; border-radius:999px; font-weight:800; font-size:12px; color:#a9c0ff; letter-spacing:.5px}
  .status{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; text-align:center}
  .status .msg{font-size:28px; font-weight:900; letter-spacing:2px; color:var(--accent); text-shadow:0 0 12px rgba(0,255,213,.35)}
  .status .msg.red{color:#ff5b5b; text-shadow:0 0 12px rgba(255,80,80,.35)}

  input[type="text"]{outline:none}
  button[disabled]{opacity:.5; pointer-events:none}
</style>
</head>
<body>
  <header>
    <div class="hud" id="life">LIFE â™¥â™¥â™¥â™¥</div>
    <div class="hud" id="timer">â± 05:00</div>
    <div class="hud" id="score">SCORE 0000</div>
  </header>

  <div id="wrap">
    <canvas id="game" width="960" height="720" aria-label="ë²½ëŒê¹¨ê¸° ê²Œì„"></canvas>

    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
    <div class="status" id="status">
      <div class="msg" id="statusMsg">PRESS ENTER</div>
    </div>

    <!-- í€´ì¦ˆ ëª¨ë‹¬ -->
    <div class="overlay" id="quizOverlay" role="dialog" aria-modal="true">
      <div class="panel">
        <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px">
          <div class="pill" id="quizBadge">ê²¨ìš¸ì•ˆì „ í€´ì¦ˆ</div>
          <div class="pill" id="quizBonus">BONUS +1000</div>
        </header>
        <div class="content">
          <h2 id="qText">Q. ì¶”ìš´ ë‚ â€¦?</h2>
          <div class="choices" id="qChoices"></div>
          <div id="qExplain" style="display:none; margin:8px 0 2px 0; color:#a6e3ff"></div>
          <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap">
            <button id="submitAnswer" title="Enter">ì •ë‹µ ì œì¶œ(Enter)</button>
            <span class="pill">â†/â†’/â†‘/â†“ ë˜ëŠ” ìˆ«ìí‚¤(1~4)ë¡œ ì„ íƒ Â· ê³µê°œ í›„ Enterë¡œ ê³„ì†</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ì¢…ë£Œ ëª¨ë‹¬ -->
    <div class="overlay" id="endOverlay" role="dialog" aria-modal="true">
      <div class="panel">
        <header style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px">
          <div class="pill">ê²°ê³¼</div>
          <div class="pill" id="endTime">â± 00:00</div>
        </header>
        <div class="content">
          <h2 id="endTitle">GAME OVER</h2>
          <p id="endDetail" style="opacity:.9">ìµœì¢… ì ìˆ˜: 0</p>

          <!-- ì´ë¦„ ì…ë ¥ë€ (ALL CLEARì—ì„œë§Œ ë³´ì„) -->
          <div id="nameWrap" style="display:none; margin:12px 0; gap:8px; align-items:center; justify-content:flex-start; flex-wrap:wrap;">
            <label for="playerName" class="pill" style="margin-right:8px">ì´ë¦„</label>
            <input id="playerName" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="12"
                   style="flex:1; min-width:220px; padding:10px 12px; border:1px solid #26406a; border-radius:10px; background:transparent; color:#e6f0ff; font-family:inherit; font-weight:800; letter-spacing:1px;">
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button id="btnRestart" title="Enter">íƒ€ì´í‹€ë¡œ(Enter)</button>
            <button id="btnSavePng" title="PNGë¡œ ì €ì¥">PNGë¡œ ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <footer style="opacity:.7; font-size:12px">
    íƒ€ì´í‹€: PRESS ENTER â†’ ì‹œì‘ / ê²Œì„ ì¤‘: â†â†’ ì´ë™, Space ì¼ì‹œì •ì§€ / ì„œë¸Œ ì¤€ë¹„: EnterÂ·Spaceë¡œ ë°œì‚¬ / í€´ì¦ˆ: ì œì¶œâ†’ê³µê°œâ†’Enterë¡œ ê³„ì†
  </footer>

<script>
(function(){
  // ===== ìœ í‹¸ =====
  const $ = sel => document.querySelector(sel);
  const timerEl = $('#timer');
  const scoreEl = $('#score');
  const lifeEl = $('#life');
  const statusEl = $('#status');
  const statusMsg = $('#statusMsg');

  // ===== ìº”ë²„ìŠ¤ ì„¸íŒ… =====
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // ===== ê²Œì„ ìƒíƒœ =====
  let running = false;
  let paused = false;
  let over = false;
  let score = 0;
  let remaining = 300; // 5ë¶„
  let lastTs = 0;
  let redUnlocked = false;
  let greensLeft = 5;
  let yellowsLeft = 3;
  let redsLeft = 2;
  let lives = 4;
  let awaitServe = false; // ìƒˆ ì„œë¸Œ ëŒ€ê¸° ìƒíƒœ (ê³µì´ íŒ¨ë“¤ì— ë¶™ì–´ìˆìŒ)

  // ===== íŒ¨ë“¤ & ë³¼ =====
  const paddle = { w:120, h:18, x:W/2-60, y:H-40, speed:580 };
  const ball = { r:9, x:W/2, y:H-60, dx:0, dy:0, speedUp:1.02, max:720 };
  const INITIAL_SPEED = 320; // ì„œë¸Œ ì‹œ ì´ˆê¸° ì†ë„ í¬ê¸°

  // ===== ë²½ëŒ ë§µ =====
  const COLS = 12, ROWS = 6, GAP=4;
  const bw = Math.floor((W - (COLS+1)*GAP)/COLS);
  const bh = 28;
  const offsetTop = 80; const offsetLeft = Math.floor((W - (bw*COLS + GAP*(COLS+1)))/2);

  const TYPE = { BASIC:'basic', GREEN:'green', YELLOW:'yellow', RED:'red' };

  const greenPos = [ [2,1],[9,1],[3,2],[8,2],[5,3] ];       // 5ê°œ
  const yellowPos = [ [4,0],[7,0],[6,3] ];                  // 3ê°œ
  const redPos = [ [5,0],[6,0] ];                           // 2ê°œ(ê°€ìš´ë° ìƒë‹¨)

  let bricks = [];
  function makeBricks(){
    bricks = [];
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const x = offsetLeft + GAP + c*(bw+GAP);
        const y = offsetTop + GAP + r*(bh+GAP);
        let type = TYPE.BASIC, hp=1, locked=false;
        if (hasCoord(greenPos,c,r)) { type=TYPE.GREEN; hp=1; }
        else if (hasCoord(yellowPos,c,r)) { type=TYPE.YELLOW; hp=2; }
        else if (hasCoord(redPos,c,r)) { type=TYPE.RED; hp=1; locked=true; }
        bricks.push({x,y,w:bw,h:bh,type,hp,alive:true,locked});
      }
    }
  }

  function hasCoord(arr,c,r){return arr.some(p=>p[0]===c && p[1]===r)}

  // ===== ì…ë ¥ =====
  const keys = {};
  window.addEventListener('keydown', e=>{ 
    keys[e.code]=true; 
    if(e.code==='Space'){
      e.preventDefault();
      if(running && !over){
        if(awaitServe){ launchBall(); }
        else { togglePause(); }
      }
    }
    if(e.code==='Enter'){
      if($('#endOverlay').classList.contains('show') && !isTyping()){
        resetToTitle();
      } else if(!running && !$('#quizOverlay').classList.contains('show')){
        startGame(); // íƒ€ì´í‹€ì—ì„œ ê²Œì„ ì‹œì‘(ì„œë¸Œ ëŒ€ê¸°)
      } else if(running && awaitServe){
        launchBall();
      }
    }
  });
  window.addEventListener('keyup', e=>{ keys[e.code]=false });
  document.addEventListener('mousemove', e=>{
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (W/rect.width);
    paddle.x = Math.max(0, Math.min(W - paddle.w, mx - paddle.w/2));
  });

  function isTyping(){
    const el = document.activeElement; return el && (el.tagName==='INPUT' || el.tagName==='TEXTAREA');
  }

  function togglePause(){ if(!running||over||awaitServe) return; paused = !paused; statusMsg.textContent = paused? 'PAUSED' : ''; statusEl.style.display = paused? 'flex':'none'; }

  // ===== íƒ€ì´í‹€ë¡œ ë³µê·€ =====
  function resetToTitle(){
    running=false; paused=false; over=false; if(timerI) clearInterval(timerI);
    score=0; remaining=300; lives=4; redUnlocked=false; greensLeft=5; yellowsLeft=3; redsLeft=2; awaitServe=false;
    statusMsg.innerHTML='PRESS ENTER'; statusEl.style.display='flex';
    $('#endOverlay').classList.remove('show');
    $('#quizOverlay').classList.remove('show');
    scoreEl.textContent = fmtScore(score);
    updateLifeHUD(); updateTimerText();
    nameWrap.style.display='none';
    btnSavePng.disabled=false; btnSavePng.title='PNGë¡œ ì €ì¥';
    if(playerName){ playerName.value=''; playerName.onkeydown=null; }
    // í™”ë©´ì„ ê¹”ë”í•˜ê²Œ: íŒ¨ë“¤ ì¤‘ì•™, ê³µë„ íŒ¨ë“¤ ìœ„ë¡œ ì •ë ¬(í‘œì‹œë§Œ)
    paddle.x = W/2 - paddle.w/2; paddle.y = H - 40;
    attachBallToPaddle();
    draw();
  }

  // ===== íƒ€ì´ë¨¸ =====
  let timerI = null;
  function startTimer(){
    remaining = 300; updateTimerText();
    if(timerI) clearInterval(timerI);
    timerI = setInterval(()=>{
      if(!running||paused) return;
      remaining = Math.max(0, remaining - 1);
      updateTimerText();
      if(remaining<=0){ gameOver(false); }
    },1000);
  }
  function updateTimerText(){
    const m = String(Math.floor(remaining/60)).padStart(2,'0');
    const s = String(remaining%60).padStart(2,'0');
    timerEl.textContent = `â± ${m}:${s}`;
  }

  function updateLifeHUD(){ lifeEl.textContent = 'LIFE ' + 'â™¥'.repeat(lives); }

  // ===== ì„œë¸Œ/ê³µ ë¶™ì´ê¸° =====
  function attachBallToPaddle(){
    awaitServe = true;
    ball.dx = 0; ball.dy = 0;
    ball.x = paddle.x + paddle.w/2;
    ball.y = paddle.y - ball.r - 1;
    statusMsg.textContent = 'LAUNCH: ENTER / SPACE';
    statusEl.style.display = 'flex';
  }
  function launchBall(){
    const angle = (Math.random()*0.6 - 0.3); // -0.3~0.3 rad ì•½ Â±17ë„
    const speed = INITIAL_SPEED;
    ball.dx = speed * Math.sin(angle) * (Math.random()<.5? -1:1);
    ball.dy = -Math.abs(speed * Math.cos(angle));
    awaitServe = false;
    statusEl.style.display='none';
  }

  // ===== ë©”ì¸ ë£¨í”„ =====
  function startGame(){
    running = true; paused=false; over=false; lastTs=0;
    makeBricks();
    // ì‹œì‘ì€ ì„œë¸Œ ëŒ€ê¸°(ê³µì€ íŒ¨ë“¤ ìœ„)
    paddle.x = W/2 - paddle.w/2; paddle.y = H - 40;
    attachBallToPaddle();

    scoreEl.textContent = fmtScore(score);
    updateLifeHUD();
    startTimer();

    requestAnimationFrame(loop);
  }

  function loop(ts){
    if(!running) return;
    const dt = lastTs? (ts - lastTs)/1000 : 0; lastTs = ts;
    if(!paused && !over){ update(dt); draw(); }
    requestAnimationFrame(loop);
  }

  function update(dt){
    if(keys['ArrowLeft']) paddle.x -= paddle.speed*dt;
    if(keys['ArrowRight']) paddle.x += paddle.speed*dt;
    paddle.x = Math.max(0, Math.min(W-paddle.w, paddle.x));

    if(awaitServe){
      // ê³µì„ íŒ¨ë“¤ì— ë¶™ì—¬ì„œ ì´ë™ë§Œ ì¶”ì 
      ball.x = paddle.x + paddle.w/2; ball.y = paddle.y - ball.r - 1;
      return; // ì¶©ëŒ/ì´ë™ ê³„ì‚° ìƒëµ
    }

    ball.x += ball.dx*dt; ball.y += ball.dy*dt;

    if(ball.x < ball.r){ ball.x = ball.r; ball.dx *= -1; }
    if(ball.x > W - ball.r){ ball.x = W - ball.r; ball.dx *= -1; }
    if(ball.y < ball.r){ ball.y = ball.r; ball.dy *= -1; }

    if(ball.y > H - ball.r){ loseLife(); return; }

    if(rectCircleCollide(paddle, ball)){
      const hit = (ball.x - (paddle.x + paddle.w/2)) / (paddle.w/2);
      const speed = Math.min(Math.hypot(ball.dx, ball.dy)*ball.speedUp, ball.max);
      const angle = hit * Math.PI/3;
      ball.dx = speed * Math.sin(angle);
      ball.dy = -Math.abs(speed * Math.cos(angle));
      ball.y = paddle.y - ball.r - 1;
    }

    for(const b of bricks){
      if(!b.alive) continue;
      if(circleRectCollide(ball, b)){
        if(b.type===TYPE.RED && (!redUnlocked || b.locked)){
          flashStatus('RED LOCKED â€” ë¨¼ì € ì´ˆë¡/ë…¸ë‘ì„ ëª¨ë‘ ê¹¨ì•¼ í•´!', true); reflectBall(ball, b); continue;
        }
        b.hp -= 1; reflectBall(ball, b);
        if(b.hp<=0){
          b.alive = false;
          if(b.type===TYPE.BASIC){ score += 100; scoreEl.textContent = fmtScore(score); }

          if(b.type===TYPE.GREEN){ greensLeft = Math.max(0, greensLeft-1); openQuiz({bonus:1000, pool:GREEN_QUIZ}); }
          if(b.type===TYPE.YELLOW){ yellowsLeft = Math.max(0, yellowsLeft-1); openQuiz({bonus:2000, pool:YELLOW_QUIZ}); }
          if(b.type===TYPE.RED){
            redsLeft = Math.max(0, redsLeft-1);
            const isFinal = (redsLeft===0);
            openQuiz({bonus:isFinal?10000:5000, pool:isFinal?FINAL_QUIZ:RED_QUIZ, final:isFinal});
          }

          if(!redUnlocked && greensLeft===0 && yellowsLeft===0){
            redUnlocked = true; bricks.filter(x=>x.type===TYPE.RED).forEach(x=>x.locked=false);
            flashStatus('RED UNLOCKED! ë¹¨ê°•ë²½ëŒ ê²©íŒŒ ê°€ëŠ¥', false);
          }
        }
        break;
      }
    }

    if(bricks.every(b=>!b.alive)) gameOver(true);
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    ctx.globalAlpha = .06; ctx.fillStyle = '#9adfff';
    for(let i=0;i<60;i++){ ctx.fillRect((i*73)%W, (i*41)%H, 2, 2); }
    ctx.globalAlpha = 1;

    for(const b of bricks){ if(!b.alive) continue; drawBrick(b); }

    ctx.fillStyle = '#c7e3ff';
    roundRect(ctx, paddle.x, paddle.y, paddle.w, paddle.h, 6, true);

    ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    const grd = ctx.createRadialGradient(ball.x-2, ball.y-2, 1, ball.x, ball.y, ball.r);
    grd.addColorStop(0, '#fff'); grd.addColorStop(1, '#7cd7ff');
    ctx.fillStyle = grd; ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,.35)'; ctx.stroke();

    ctx.globalAlpha=.15; ctx.strokeStyle='#00ffd5'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(20,60); ctx.lineTo(W-20,60); ctx.stroke(); ctx.globalAlpha=1;

    ctx.globalAlpha=.15; ctx.fillStyle = redUnlocked? '#00ffd5' : '#ff6b6b';
    ctx.font='700 14px ui-monospace, monospace';
    ctx.fillText(redUnlocked? 'ğŸ”“ RED UNLOCKED' : 'ğŸ”’ RED LOCKED', 20, 50);
    ctx.globalAlpha=1;
  }

  function drawBrick(b){
    ctx.save();
    ctx.translate(b.x, b.y);
    const grad = ctx.createLinearGradient(0,0, b.w, b.h);
    if(b.type==='green'){ grad.addColorStop(0,'#1e8e5a'); grad.addColorStop(1,'#35d07f'); }
    else if(b.type==='yellow'){ grad.addColorStop(0,'#c7a700'); grad.addColorStop(1,'#f8d34b'); }
    else if(b.type==='red'){ grad.addColorStop(0,'#b6172f'); grad.addColorStop(1,'#ff5b5b'); }
    else { grad.addColorStop(0,'#5562d6'); grad.addColorStop(1,'#9aa7ff'); }
    ctx.fillStyle = grad; roundRect(ctx, 0,0,b.w,b.h, 6, true);
    ctx.strokeStyle = 'rgba(255,255,255,.15)'; ctx.strokeRect(0.5,0.5,b.w-1,b.h-1);
    ctx.font='800 12px ui-monospace, monospace'; ctx.textAlign='center'; ctx.textBaseline='middle';
    if(b.type==='green'){ ctx.fillStyle='#d9ffe6'; ctx.fillText('G', b.w/2, b.h/2); }
    if(b.type==='yellow'){ ctx.fillStyle='#fff4c7'; ctx.fillText(b.hp===2?'Y(2)':'Y(1)', b.w/2, b.h/2); }
    if(b.type==='red'){ ctx.fillStyle='#ffd6da'; ctx.fillText(redUnlocked?'R':'RğŸ”’', b.w/2, b.h/2); }
    ctx.restore();
  }

  function roundRect(ctx,x,y,w,h,r,fill){
    ctx.beginPath();
    ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
    if(fill) ctx.fill(); else ctx.stroke();
  }

  function rectCircleCollide(rect, c){
    const cx = Math.max(rect.x, Math.min(c.x, rect.x+rect.w));
    const cy = Math.max(rect.y, Math.min(c.y, rect.y+rect.h));
    const dx = c.x - cx, dy = c.y - cy; return (dx*dx + dy*dy) <= (c.r*c.r);
  }
  function circleRectCollide(c, rect){ return rectCircleCollide(rect,c); }
  function reflectBall(ball, rect){
    const prevX = ball.x - Math.sign(ball.dx);
    const prevY = ball.y - Math.sign(ball.dy);
    const fromLeft = prevX < rect.x;
    const fromRight = prevX > rect.x + rect.w;
    const fromTop = prevY < rect.y;
    const fromBottom = prevY > rect.y + rect.h;
    if(fromLeft || fromRight){ ball.dx *= -1; }
    if(fromTop || fromBottom){ ball.dy *= -1; }
  }

  function fmtScore(s){ return 'SCORE ' + String(s).padStart(4,'0'); }

  function flashStatus(text, danger){
    statusMsg.textContent = text; statusMsg.classList.toggle('red', !!danger); statusEl.style.display='flex';
    clearTimeout(flashStatus._t);
    flashStatus._t = setTimeout(()=>{ statusEl.style.display='none'; statusMsg.classList.remove('red'); }, 1200);
  }

  function loseLife(){
    if(over) return;
    lives--; updateLifeHUD();
    flashStatus('LIFE -1', true);
    if(lives<=0){ gameOver(false); return; }
    // ë‹¤ìŒ ì„œë¸Œ ì¤€ë¹„
    attachBallToPaddle();
  }

  // ===== í€´ì¦ˆ (ìƒ‰ê¹”ë³„ í’€ ë¶„ë¦¬) =====
  const quizOverlay = document.getElementById('quizOverlay');
  const qText = document.getElementById('qText');
  const qChoices = document.getElementById('qChoices');
  const qExplain = document.getElementById('qExplain');
  const quizBadge = document.getElementById('quizBadge');
  const quizBonus = document.getElementById('quizBonus');
  const btnSubmit = document.getElementById('submitAnswer');

  const GREEN_QUIZ = [
    {q:'ë‚œë°©ê¸°(ë³´ì¼ëŸ¬Â·ê°€ìŠ¤ë‚œë¡œ ë“±) ì‚¬ìš© ì‹œ ê¸°ë³¸ ì•ˆì „ìˆ˜ì¹™ì€?', c:['ì°½ë¬¸ì„ ê¼­ ë‹«ì•„ë‘”ë‹¤','ì •ê¸°ì ìœ¼ë¡œ í™˜ê¸°í•œë‹¤','ë¶ˆê½ƒì„ ìµœëŒ€í•œ í‚¤ìš´ë‹¤','ë¹¨ë˜ë¥¼ ë°”ë¡œ ìœ„ì— ë§ë¦°ë‹¤'], a:1, e:'ì¼ì‚°í™”íƒ„ì†Œ ì¤‘ë… ì˜ˆë°©ì„ ìœ„í•´ ì£¼ê¸°ì  í™˜ê¸°ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.'},
    {q:'ë¹™íŒê¸¸ ë³´í–‰ ì‹œ ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì€?', c:['ë³´í­ì„ í¬ê²Œ í•œë‹¤','ì†ì„ ì£¼ë¨¸ë‹ˆì— ë„£ëŠ”ë‹¤','ë³´í­ì„ ì‘ê²Œ, ë¬´ê²Œì¤‘ì‹¬ ë‚®ê²Œ','íœ´ëŒ€í°ì„ ë³´ë©° ê±·ëŠ”ë‹¤'], a:2, e:'ë³´í­ì„ ì¤„ì´ê³  ë¬´ê²Œì¤‘ì‹¬ì„ ë‚®ì¶”ë©´ ë¯¸ë„ëŸ¬ì§ì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'},
    {q:'ì „ê¸°ì¥íŒì„ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€?', c:['ì ‘ì–´ì„œ ì‚¬ìš©','í•­ìƒ ìµœê³ ì˜¨ë„','ë‘êº¼ìš´ ì´ë¶ˆ ì—¬ëŸ¬ ê²¹','í´ì„œ ì‚¬ìš©, ì¥ì‹œê°„ ê³ ì˜¨ í”¼í•¨'], a:3, e:'ì ‘ê±°ë‚˜ ì¥ì‹œê°„ ê³ ì˜¨ì€ í™”ì¬ ìœ„í—˜. í´ì„œ ì‚¬ìš©í•˜ê³  ê³ ì˜¨ ìœ ì§€ ê¸ˆì§€.'},
    {q:'ìŠ¤í‚¤ì¥/ëˆˆì°ë§¤ì¥ì—ì„œ ê¸°ë³¸ ìˆ˜ì¹™ì€?', c:['ì •ì§€ ì—°ìŠµì€ í•„ìš” ì—†ìŒ','í—¬ë©§Â·ë³´í˜¸ì¥êµ¬ ì°©ìš©','ì‚¬ëŒ ë§ì€ ê³³ì—ì„œ ì†ë„ ë‚´ê¸°','ì½”ìŠ¤ ì—­ì£¼í–‰'], a:1, e:'í—¬ë©§ ë“± ë³´í˜¸ì¥êµ¬ë¥¼ ì°©ìš©í•˜ê³  ê·œì¹™ì„ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤.'}
  ];

  const YELLOW_QUIZ = [
    {q:'ë™ìƒ ì˜ì‹¬ ì‹œ ì˜¬ë°”ë¥¸ ì‘ê¸‰ì²˜ì¹˜ëŠ”?', c:['ëˆˆìœ¼ë¡œ ì„¸ê²Œ ë¬¸ì§€ë¥¸ë‹¤','50â„ƒ ëœ¨ê±°ìš´ ë¬¼ì— ë¹ ë¥´ê²Œ ë°ìš´ë‹¤','37~39â„ƒ ë¯¸ì§€ê·¼í•œ ë¬¼ì— ì„œì„œíˆ ë°ìš´ë‹¤','ë°”ëŒ ì¬ë©° ìì—°íšŒë³µ'], a:2, e:'ë¬¸ì§€ë¥´ë©´ ì†ìƒ, ë„ˆë¬´ ëœ¨ê±°ìš´ ë¬¼ë„ ê¸ˆë¬¼. ë¯¸ì§€ê·¼í•œ ë¬¼ì— ì„œì„œíˆ.'},
    {q:'ë¸”ë™ì•„ì´ìŠ¤ê°€ íŠ¹íˆ ì˜ ìƒê¸°ëŠ” ê³³ì€?', c:['í–‡ë³• ì˜ ë“œëŠ” ë„ë¡œ','í„°ë„Â·êµëŸ‰Â·ê·¸ëŠ˜ì§„ êµ¬ê°„','ë„ì‹¬ í•œë³µíŒ','íš¡ë‹¨ë³´ë„ë§Œ'], a:1, e:'ê·¸ëŠ˜Â·êµëŸ‰Â·í„°ë„ ì¶œì…êµ¬ ë“± ë…¸ë©´ì˜¨ë„ê°€ ë‚®ì€ êµ¬ê°„.'},
    {q:'í­ì„¤ í›„ ìë™ì°¨ ì‹œë™ ì „ ë°˜ë“œì‹œ í™•ì¸í•  ê²ƒì€?', c:['ì—”ì§„ì˜¤ì¼ ìƒ‰','ë°°ê¸°êµ¬(ë¨¸í”ŒëŸ¬) ë§‰í˜','ì™€ì´í¼ ê³ ë¬´ ìƒ‰','íƒ€ì´ì–´ íœ  ë””ìì¸'], a:1, e:'ë°°ê¸°êµ¬ê°€ ë§‰íˆë©´ COê°€ ì‹¤ë‚´ë¡œ ìœ ì…ë˜ì–´ ë§¤ìš° ìœ„í—˜í•©ë‹ˆë‹¤.'},
    {q:'ì œì„¤ ì‘ì—… ì‹œ ì£¼ì˜í•  ì ì€?', c:['ì§§ì€ ì‹œê°„ ì „ë ¥ì§ˆì£¼','í—ˆë¦¬ êµ½í˜€ ë¹ ë¥´ê²Œ í¼ë‚´ê¸°','ì¤‘ê°„ì¤‘ê°„ ì‰¬ë©° ëª¸ í’€ê¸°','ì‚¬ë‹¤ë¦¬ë¡œ ì†ë„ ë†’ì´ê¸°'], a:2, e:'ë¬´ë¦¬í•˜ë©´ ì‹¬í˜ˆê´€ ë¶€ë‹´ í¼. ìŠ¤íŠ¸ë ˆì¹­Â·íœ´ì‹ì´ ì¤‘ìš”.'}
  ];

  const RED_QUIZ = [
    {q:'í˜¹í•œ ì† ì €ì²´ì˜¨ì¦ ì˜ì‹¬ ì‹œ ëŒ€ì²˜ëŠ”?', c:['ëœ¨ê±°ìš´ ìš•ì¡°ì— ë°”ë¡œ ë„£ê¸°','ì°¬ë¬¼ ìƒ¤ì›Œ','ë”°ëœ»í•œ ì¥ì†Œë¡œ ì´ë™í•´ ë³´ì˜¨Â·ìˆ˜ë¶„ ë³´ì¶©','ë‘êº¼ìš´ ì˜· ë²—ì–´ ì‹íˆê¸°'], a:2, e:'ë”°ëœ»í•œ ì¥ì†Œë¡œ ì´ë™, ì –ì€ ì˜· êµì²´, ë³´ì˜¨Â·ìˆ˜ë¶„ ë³´ì¶©.'},
    {q:'ê°€ì •ìš© CO(ì¼ì‚°í™”íƒ„ì†Œ) ê²½ë³´ê¸° ì„¤ì¹˜ ìœ„ì¹˜ëŠ”?', c:['ì²œì¥ ì¤‘ì•™ ì•„ë¬´ ê³³','ë°”ë‹¥ ë°”ë¡œ ìœ„','ë³´ì¼ëŸ¬Â·ê°€ìŠ¤ê¸°ê¸° ì£¼ë³€ ë²½ë©´ ë†’ì´(ì§€ì¹¨ ì¤€ìˆ˜)','í˜„ê´€ë¬¸ ë°”ê¹¥'], a:2, e:'ì œì¡°ì‚¬ ì§€ì¹¨ ë†’ì´, ê¸°ê¸° ê·¼ì²˜ì— ì„¤ì¹˜.'},
    {q:'ë¹™íŒì—ì„œ ë„˜ì–´ì§ˆ ë•Œ ë¹„êµì  ì•ˆì „í•œ ìì„¸ëŠ”?', c:['ì†ë°”ë‹¥ í´ì„œ ì§šê¸°','ë¨¸ë¦¬ë¶€í„° ì•ìœ¼ë¡œ ìˆ™ì´ê¸°','ëª¸ì„ ì›…í¬ë¦¬ê³  ì˜†ìœ¼ë¡œ ë„˜ì–´ê°€ê¸°','ë¬´ë¦ì„ ì­‰ í¸ ì±„ ë¯¸ë„ëŸ¬ì§€ê¸°'], a:2, e:'ëª¸ì„ ì›…í¬ë ¤ ì¶©ê²© ë¶„ì‚°, ì˜†ìœ¼ë¡œ ë„˜ì–´ì§€ë“¯.'},
    {q:'ê²¨ìš¸ì²  í˜¸í¡ê¸° ì§ˆí™˜ ê¸°ë³¸ ì˜ˆë°©ë²•ì€?', c:['ì† ì”»ê¸°ì™€ ê¸°ì¹¨ ì˜ˆì ˆ ì¤€ìˆ˜','ë§ˆìŠ¤í¬ ì ˆëŒ€ ê¸ˆì§€','ë”°ëœ»í•œ ìŒë£Œë§Œ ë§ˆì‹œê¸°','í•˜ë£¨ ì¢…ì¼ ë‚œë°© ë„ê¸°'], a:0, e:'ì† ì”»ê¸°Â·ê¸°ì¹¨ ì˜ˆì ˆÂ·ì ì ˆí•œ í™˜ê¸°ì™€ ë³´ì˜¨ì´ ê¸°ë³¸.'}
  ];

  const FINAL_QUIZ = [
    {q:'ìµœí›„ì˜ ë¬¸ì œ! í•œíŒŒ ëŒ€ë¹„ ê°€ì • ì•ˆì „ ì²´í¬ë¡œ ì˜³ì§€ ì•Šì€ ê²ƒì€?', c:['ë¹„ìƒ ë¬¼Â·ì†ì „ë“±Â·ê±´ì „ì§€ ì¤€ë¹„','ë‚œë°©ê¸° ì ê²€ê³¼ í™˜ê¸° ë³‘í–‰','ì¼ì‚°í™”íƒ„ì†Œ ê²½ë³´ê¸°ë¥¼ êº¼ ë‘”ë‹¤','ë¯¸ë„ëŸ¼ ë°©ì§€ ì‹ ë°œ ì¤€ë¹„'], a:2, e:'ê²½ë³´ê¸°ëŠ” í•­ìƒ ì¼  ìƒíƒœë¡œ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.'},
    {q:'ìµœí›„ì˜ ë¬¸ì œ! í˜¹í•œ ì† ì €ì²´ì˜¨ì¦ ì‘ê¸‰ ëŒ€ì²˜ëŠ”?', c:['ëœ¨ê±°ìš´ ìš•ì¡°ì— ë°”ë¡œ ë„£ëŠ”ë‹¤','ì –ì€ ì˜·ì„ ê°ˆì•„ì…íˆê³  ë‹´ìš”ë¡œ ë³´ì˜¨','ì•Œì½”ì˜¬ì„ ë§ˆì‹œê²Œ í•œë‹¤','ë°”ëŒ ì¬ë©° ë‹¨ë ¨'], a:1, e:'ì –ì€ ì˜· êµì²´Â·ë³´ì˜¨, ì˜ë£Œê¸°ê´€ìœ¼ë¡œ ì´ë™.'}
  ];

  function getRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  let quizKeyHandler = null;
  let currentBonus = 0;

  function openQuiz({bonus=1000, pool=GREEN_QUIZ, final=false}={}){
    if(over) return;
    paused = true; quizOverlay.classList.add('show');
    currentBonus = bonus;
    quizBadge.textContent = final? 'ìµœí›„ì˜ ë¬¸ì œ' : 'ê²¨ìš¸ì•ˆì „ í€´ì¦ˆ';
    quizBonus.textContent = (final? 'FINAL +' : 'BONUS +') + bonus;

    const q = getRandom(pool);

    qText.textContent = 'Q. ' + q.q; qExplain.style.display='none'; qExplain.textContent='';
    qChoices.innerHTML = ''; qChoices.classList.remove('revealed');

    q.c.forEach((text, i)=>{
      const id = 'c_'+Date.now()+'_'+i;
      const label = document.createElement('label'); label.className='choice';
      const radio = document.createElement('input'); radio.type='radio'; radio.name='quizChoice'; radio.value=i; radio.id=id; radio.style.marginTop='2px';
      const span = document.createElement('span'); span.textContent = text;
      label.appendChild(radio); label.appendChild(span); qChoices.appendChild(label);
    });
    let idx = 0; const radios = [...qChoices.querySelectorAll('input[name="quizChoice"]')]; if(radios[0]) radios[0].checked = true;

    let revealed = false; // ì •ë‹µ ê³µê°œ ì—¬ë¶€
    let handled = false;  // ì ìˆ˜/ë¼ì´í”„ ì²˜ë¦¬ 1íšŒë§Œ

    const continuePlay = ()=>{
      quizOverlay.classList.remove('show');
      paused=false;
      if(quizKeyHandler){ window.removeEventListener('keydown', quizKeyHandler); quizKeyHandler=null; }
      if(lives<=0){ gameOver(false); }
    };

    const reveal = (isCorrect)=>{
      if(revealed) return; revealed = true; qChoices.classList.add('revealed');
      const choiceLabels = [...qChoices.querySelectorAll('label.choice')];
      const selIndex = radios.findIndex(r=>r.checked);
      choiceLabels.forEach((lab,i)=>{
        if(i===q.a) lab.classList.add('correct');
        if(i===selIndex && !isCorrect) lab.classList.add('wrong');
      });
      qExplain.style.display='block';
      if(!handled){
        handled = true;
        if(isCorrect){ score += currentBonus; scoreEl.textContent = fmtScore(score); qExplain.textContent = `ì •ë‹µ! +${currentBonus}ì  ë³´ë„ˆìŠ¤. ` + q.e; }
        else { lives--; updateLifeHUD(); qExplain.textContent = 'ì˜¤ë‹µ! ëª©ìˆ¨ -1. ' + q.e; }
      }
      btnSubmit.textContent = 'ê³„ì†(Enter)';
    };

    btnSubmit.onclick = ()=>{
      if(!revealed){
        const sel = qChoices.querySelector('input[name="quizChoice"]:checked');
        if(!sel){ qExplain.style.display='block'; qExplain.textContent='ì •ë‹µì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'; return; }
        const isCorrect = Number(sel.value) === q.a;
        reveal(isCorrect);
      } else {
        continuePlay();
      }
    };

    if(quizKeyHandler){ window.removeEventListener('keydown', quizKeyHandler); }
    quizKeyHandler = (e)=>{
      const radios = [...qChoices.querySelectorAll('input[name="quizChoice"]')];
      if(!quizOverlay.classList.contains('show')) return;
      if(!revealed){
        if(['ArrowDown','ArrowRight','KeyS','KeyD'].includes(e.code)){
          idx = (idx+1) % radios.length; radios.forEach((r,i)=>r.checked = (i===idx)); e.preventDefault();
        } else if(['ArrowUp','ArrowLeft','KeyW','KeyA'].includes(e.code)){
          idx = (idx-1+radios.length) % radios.length; radios.forEach((r,i)=>r.checked = (i===idx)); e.preventDefault();
        } else if(/^Digit[1-9]$/.test(e.code)){
          const n = Math.min(9, Math.max(1, Number(e.code.replace('Digit','')))) - 1; if(radios[n]){ idx=n; radios.forEach((r,i)=>r.checked = (i===idx)); }
        } else if(e.code==='Enter'){ btnSubmit.click(); e.preventDefault(); }
      } else {
        if(e.code==='Enter'){ continuePlay(); e.preventDefault(); }
      }
    };
    window.addEventListener('keydown', quizKeyHandler);
  }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j]]; } return arr; }

  // ===== ì—”ë”© / ì €ì¥ =====
  const endOverlay = document.getElementById('endOverlay');
  const endTitle = document.getElementById('endTitle');
  const endDetail = document.getElementById('endDetail');
  const endTime = document.getElementById('endTime');
  const btnRestart = document.getElementById('btnRestart');
  const btnSavePng = document.getElementById('btnSavePng');
  const nameWrap = document.getElementById('nameWrap');
  const playerName = document.getElementById('playerName');

  btnRestart.onclick = ()=>{ resetToTitle(); };
  btnSavePng.onclick = ()=>{ if(!btnSavePng.disabled) savePNG(endTitle.textContent); };

  function savePNG(finalText){
    const off = document.createElement('canvas'); off.width = W; off.height = H; const g = off.getContext('2d');
    g.fillStyle = '#0a0e17'; g.fillRect(0,0,W,H);
    g.drawImage(canvas,0,0);
    g.fillStyle = 'rgba(0,0,0,0.65)'; g.fillRect(0, H-160, W, 160);
    g.fillStyle = '#ffffff';
    g.font = '700 34px ui-monospace, monospace'; g.fillText(finalText, 24, H-112);
    g.font = '700 24px ui-monospace, monospace'; g.fillText('SCORE: '+score, 24, H-80);
    const now = new Date();
    const stamp = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
    const pname = (playerName && playerName.value.trim()) || '';
    const footer = (pname? ('NAME: '+pname+'   â€¢   ') : '') + 'TIME LEFT: ' + timerEl.textContent.replace('â± ','') + '   â€¢   SAVED: ' + stamp;
    g.font = '600 16px ui-monospace, monospace'; g.fillText(footer, 24, H-48);

    const url = off.toDataURL('image/png');
    const a = document.createElement('a');
    const safe = finalText.split(' ').join('_').toLowerCase();
    a.href=url; a.download = `winter-breakout-${safe}-${Date.now()}.png`; a.click();
  }

  function gameOver(win){
    over = true; running=false; if(timerI) clearInterval(timerI);
    statusEl.style.display='flex';
    const title = win ? 'ALL CLEAR' : 'GAME OVER';
    statusMsg.innerHTML = win ? `ğŸ‰ ALL CLEAR!<br>ìµœì¢… ì ìˆ˜: ${score}` : `â° GAME OVER!<br>ìµœì¢… ì ìˆ˜: ${score}`;

    endTitle.textContent = title;
    endDetail.textContent = `ìµœì¢… ì ìˆ˜: ${score}`;
    endTime.textContent = timerEl.textContent;

    if(win){
      nameWrap.style.display='flex';
      if(playerName){
        playerName.value='';
        setTimeout(()=>playerName.focus(), 50);
        btnSavePng.disabled = true; btnSavePng.title='ì´ë¦„ ì…ë ¥ í›„ Enterë¡œ ì €ì¥';
        playerName.onkeydown = (e)=>{
          if(e.key==='Enter'){
            e.preventDefault();
            const v = playerName.value.trim();
            if(!v) return; // ë¹ˆ ì´ë¦„ì€ ë¬´ì‹œ
            btnSavePng.disabled = false; btnSavePng.title='PNGë¡œ ì €ì¥';
            savePNG(endTitle.textContent); // Enterë¡œ ì¦‰ì‹œ ì €ì¥
          }
        };
      }
    } else {
      nameWrap.style.display='none';
      btnSavePng.disabled = false; btnSavePng.title='PNGë¡œ ì €ì¥';
      if(playerName) playerName.onkeydown = null;
    }

    endOverlay.classList.add('show');
  }

  // ì´ˆê¸°: íƒ€ì´í‹€ í™”ë©´
  statusEl.style.display='flex';
  statusMsg.innerHTML = 'PRESS ENTER';
  // ìº”ë²„ìŠ¤ ì´ˆê¸° í‘œì‹œëŠ” íŒ¨ë“¤+ê³µì„ í•˜ë‹¨ì— ê·¸ë ¤ ë†“ê¸°
  attachBallToPaddle();
  draw();

})();
</script>
</body>
</html>
